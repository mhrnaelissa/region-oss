import PDFDocument from "pdfkit";
import { sendStream, setHeader } from "h3";
import { defu } from "defu";
export function createPDF(options, data, layout, streamToFile) {
  const optionsWithDefaults = defu(options, useRuntimeConfig().public.pdf.defaultDocOptions);
  const formattedOptions = {
    ...optionsWithDefaults,
    margins: {
      ...optionsWithDefaults.margins,
      ...layout?.header ? { top: optionsWithDefaults.margins.top + layout.header.height } : {},
      ...layout?.footer ? { bottom: optionsWithDefaults.margins.bottom - layout.footer.height } : {}
    }
  };
  const doc = new PDFDocument(formattedOptions);
  doc.data = data;
  doc.layout = layout;
  if (streamToFile) {
    doc.pipe(streamToFile);
  }
  return doc;
}
export const streamReturnPDF = async (event, pdf) => {
  try {
    const doc = await Promise.resolve(pdf);
    if (doc.info.Title) {
      setHeader(event, "Content-disposition", `filename=${doc.info.Title}.pdf`);
    }
    setHeader(event, "Content-Type", "application/pdf");
    return sendStream(event, doc);
  } catch (error) {
    console.error("nuxt-pdf: Error during PDF generation:", error);
    throw new Error("PDF generated failed.");
  }
};
